{{ define "main" }}
{{ partial "back_link.html" .}}

<script type="text/javascript">
  function loadScoring() {
    generatorblock = document.getElementById("generate_certificate_inputs");
    scoreblock = document.getElementById("scoreblock");
    nojs = document.getElementById("nojs");
    
    generatorblock.style.visibility = "visible";
    scoreblock.style.visibility = "visible";
    nojs.style.visibility = "hidden";
    
  }
  
  function calculateScore() {
    var score = 0;
    const inputs = document.getElementsByTagName("input");
    for (const input of inputs) {
      if (input.getAttribute('type')=='checkbox') {
        if (input.checked) {
          score += parseInt(input.value);
        }
      }
    }
    const scorebox = document.getElementById('score');
    scorebox.innerText = score;
  }
</script>

<article>

  <div id="scoreblock">
    <div id="scoreblock-inner">
      <h1>Score: <span id="score">0</span></h1>
    </div>
  </div>

  <h1>{{ .Title }}</h1>

  {{ $data := dict }}
  {{ $path := "purityquestions.json" }}
  {{ with resources.Get $path }}
    {{ with . | transform.Unmarshal }}
      {{ $data = . }}
    {{ end }}
  {{ else }}
    {{ errorf "Unable to get global resource %q" $path }}
  {{ end }}

  <form action="none">
    {{ range $data }}
      <h2>{{ .category }}</h2>
        <ol>
          {{ range .questions }}
            <li><input type="checkbox" oninput="calculateScore()" value="{{ default 1 .points }}" />{{ .question | markdownify }}</li>
            {{ if .subquestions }}
              <ol>
                {{ range .subquestions }}
                  <li><input type="checkbox" oninput="calculateScore()" value="{{ default 1 .points }}" />... {{ .question | markdownify }}</li>
                {{ end }}
              </ol>
            {{ end }}
          {{ end }}
        </ol>
      {{ end }}
      <div id="generate_certificate_inputs">
        <br />
        <label for="name">Your Name:</label>
        <input type="text" name="name" id="name" />
        <br />
        <label for="callsign">Your Callsign:</label>
        <input type="text" name="callsign" id="callsign" />
        <br />
        <input type="submit" value="Generate Certificate" />
      </div>
  </form>
  <div id="nojs">
    Hello! It looks like you're not using JavaScript. That's totally great! The entire quiz is statically generated with <a href="https://gohugo.io/">Hugo</a> and our entire page source is available <a href="https://github.com/ussjoin/purity.nars.narwhal.be">on GitHub</a>. Unfortunately, it means we can't calculate your score or generate your certificate, because we do all that client-side for maximum privacy (instead of in a Perl script like in the good old days). If you have an idea for how to improve our NoJS experience, please <a href="mailto:nars@narwhal.be">contact us</a>!
  </div>
</article>
<script>
  // self executing function here
  (function() {
    loadScoring();
  })();
</script>
{{ end }}
